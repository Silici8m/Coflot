<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supervision Flotte ROS2</title>

    <script src="https://code.createjs.com/1.0.0/easeljs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/eventemitter2@6.4.9/lib/eventemitter2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/roslib@1/build/roslib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ros2d@0.9.0/build/ros2d.min.js"></script>

    <style>
        /* --- RESET & BASE --- */
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background-color: #121212; color: #e0e0e0; height: 100vh; overflow: hidden; }
        
        /* --- LAYOUT 3 COLONNES --- */
        .main-container { display: grid; grid-template-columns: 350px 1fr 300px; height: 100%; }
        
        .col-left { background-color: #1e1e1e; border-right: 1px solid #333; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; }
        
        /* MODIFICATION COLONNE CENTRALE POUR LA CARTE */
        .col-center { 
            background-color: #0f0f0f; 
            position: relative; 
            overflow: hidden; /* Important pour que le canvas ne d√©borde pas */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .col-right { background-color: #1e1e1e; border-left: 1px solid #333; padding: 15px; }

        /* --- STYLES INPUTS (Missions) --- */
        h2 { margin-top: 0; font-size: 1.1rem; border-bottom: 2px solid #00c853; padding-bottom: 5px; color: #00c853; }
        h3 { font-size: 0.9rem; color: #bbb; margin-bottom: 10px; }
        .input-group { margin-bottom: 10px; display: flex; flex-direction: column; }
        label { font-size: 0.8rem; margin-bottom: 4px; color: #888; }
        input[type="text"], input[type="number"], select { background: #2c2c2c; border: 1px solid #444; color: white; padding: 5px; border-radius: 4px; }
        
        .mission-list-container { flex: 0 0 auto; max-height: 30%; overflow-y: auto; background: #252525; padding: 10px; border-radius: 6px; }
        .mission-item { font-size: 0.8rem; padding: 5px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; }
        .status-active { color: #4caf50; }
        .status-pending { color: #ff9800; }
        .new-mission-container { flex: 1; display: flex; flex-direction: column; gap: 10px; }
        
        /* Styles Waypoints */
        .waypoint-card { border: 2px solid #00897b; background: #232f2d; padding: 10px; border-radius: 6px; margin-bottom: 10px; }
        .wp-row-1 { display: flex; gap: 5px; align-items: center; margin-bottom: 8px; }
        .wp-select-type { flex: 2; min-width: 0; }
        .wp-coord { width: 40px; text-align: center; }
        .wp-coord-label { font-weight: bold; font-size: 0.9rem; color: #00897b; }
        .btn-select { background: #00796b; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.75rem; }
        .wp-row-2 { display: flex; gap: 10px; align-items: center; justify-content: space-between; }
        .wp-check-group, .wp-time-group { display: flex; align-items: center; gap: 5px; font-size: 0.85rem; }
        .wp-time-input { width: 50px; }
        .btn-save { background: transparent; border: 2px solid #00897b; color: #00897b; font-weight: bold; padding: 2px 8px; border-radius: 4px; cursor: pointer; }
        .actions-bar { margin-top: auto; display: flex; gap: 10px; }
        .btn-main { flex: 1; padding: 10px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; }
        .btn-add { background: #444; color: white; }
        .btn-send { background: #00c853; color: black; }

        /* Style sp√©cifique pour le canvas ROS */
        #map-canvas {
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body onload="initROS()"> <div class="main-container">
    <div class="col-left">
        <div>
            <h2>√âtat des Missions</h2>
            <div class="mission-list-container" id="missionDisplay">
                <div class="mission-item"><span>Mission Alpha</span><span class="status-active">‚óè En cours</span></div>
            </div>
        </div>
        <div class="new-mission-container">
            <h2>Nouvelle Mission</h2>
            <div class="input-group"><label>Nom</label><input type="text" id="missionName"></div>
            <div class="input-group"><label>Priorit√©</label><input type="number" id="missionPriority" value="1"></div>
            <h3>Points de passage</h3>
            <div id="waypointsContainer"></div>
            <div class="actions-bar">
                <button class="btn-main btn-add" onclick="addWaypointUI()">+ Point</button>
                <button class="btn-main btn-send" onclick="sendMissionToROS()">Envoyer</button>
            </div>
        </div>
    </div>

    <div class="col-center" id="map-panel">
        <div id="status-indicator" style="position: absolute; top: 10px; left: 10px; color: red; font-weight: bold; z-index: 10;">
            üî¥ D√©connect√© (Lancer rosbridge)
        </div>
    </div>

    <div class="col-right">
        <h2>Info Flotte</h2>
        <p style="font-size: 0.8rem; color: #888;">En attente de connexion...</p>
    </div>
</div>

<script>
    // --- PARTIE 1 : INTERFACE MISSIONS (Code pr√©c√©dent) ---
    function createWaypointTemplate(id) {
        return `<div class="waypoint-card" id="wp-${id}">
            <div class="wp-row-1">
                <select class="wp-select-type" onchange="toggleCoordInput(${id}, this)">
                    <option value="custom">Perso ‚úèÔ∏è</option>
                    <option value="home">Home Base</option>
                </select>
                <span class="wp-coord-label">x</span><input type="text" class="wp-coord" name="x">
                <span class="wp-coord-label">y</span><input type="text" class="wp-coord" name="y">
                <span class="wp-coord-label">z</span><input type="text" class="wp-coord" name="z">
                <button class="btn-select">Select</button>
            </div>
            <div class="wp-row-2">
                <div class="wp-check-group"><span>Validation</span><input type="checkbox" checked name="validation"></div>
                <div class="wp-time-group"><span>Temps</span><input type="number" class="wp-time-input" value="0" name="stopTime"></div>
                <button class="btn-save" onclick="removeWaypoint(${id})">Suppr</button>
            </div>
        </div>`;
    }
    let waypointCount = 0;
    function addWaypointUI() {
        waypointCount++;
        document.getElementById('waypointsContainer').insertAdjacentHTML('beforeend', createWaypointTemplate(waypointCount));
    }
    function removeWaypoint(id) { document.getElementById(`wp-${id}`)?.remove(); }
    window.toggleCoordInput = function(id, selectEl) { /* ...Logique input... */ }
    function sendMissionToROS() { console.log("Envoi..."); }
    addWaypointUI();

    // --- PARTIE 2 : INTEGRATION CARTE ROS (ROS2DJS) ---
    
    // Variables globales pour y acc√©der plus tard (ajout de robots)
    let ros;
    let viewer;
    let gridClient;

    function initROS() {
        // 1. Connexion √† ROS via rosbridge
        ros = new ROSLIB.Ros({
            url : 'ws://localhost:9090' // Assurez-vous que rosbridge_server tourne ici
        });

        ros.on('connection', function() {
            document.getElementById('status-indicator').innerHTML = "üü¢ Connect√©";
            document.getElementById('status-indicator').style.color = "#00c853";
            console.log('Connect√© au websocket ROS.');
        });

        ros.on('error', function(error) {
            document.getElementById('status-indicator').innerHTML = "üî¥ Erreur";
            console.log('Erreur de connexion websocket :', error);
        });

        ros.on('close', function() {
            document.getElementById('status-indicator').innerHTML = "üî¥ Ferm√©";
            console.log('Connexion websocket ferm√©e.');
        });

        // 2. Cr√©ation du visualiseur (Le Canvas)
        // On r√©cup√®re la taille r√©elle de la colonne centrale pour adapter le canvas
        const mapPanel = document.getElementById('map-panel');
        const width = mapPanel.offsetWidth;
        const height = mapPanel.offsetHeight;

        viewer = new ROS2D.Viewer({
            divID : 'map-panel', // ID du conteneur HTML
            width : width,
            height : height,
            background : '#0f0f0f' // Fond sombre pour coller au th√®me
        });

        // 3. Client Grid pour r√©cup√©rer la map (Topic par d√©faut: /map)
        gridClient = new ROS2D.OccupancyGridClient({
            ros : ros,
            rootObject : viewer.scene,
            continuous: false // False = on charge la map statique une fois (mieux pour la perf si map fixe)
        });

        // 4. Gestion de l'√©chelle et du centrage une fois la carte re√ßue
        gridClient.on('change', function() {
            // C'est ICI qu'on ma√Ætrise la position.
            
            // L'option du tuto : "Remplir l'√©cran avec la map"
            // viewer.scaleToDimensions(gridClient.currentGrid.width, gridClient.currentGrid.height);
            
            // Ma recommandation pour garder le contr√¥le des coordonn√©es :
            // On centre la vue sur la carte, mais on garde le ratio d'aspect.
            // ros2djs place l'origine de la map (0,0 du monde ROS) correctement dans la sc√®ne.
            
            viewer.scaleToDimensions(gridClient.currentGrid.width, gridClient.currentGrid.height);
            viewer.shift(gridClient.currentGrid.pose.position.x, gridClient.currentGrid.pose.position.y);
            
            console.log("Carte re√ßue :", gridClient.currentGrid);
        });
    }

    // Gestion du redimensionnement de la fen√™tre
    window.addEventListener('resize', function() {
        if(viewer && document.getElementById('map-panel')) {
            const panel = document.getElementById('map-panel');
            viewer.resize(panel.offsetWidth, panel.offsetHeight);
        }
    });

</script>
</body>
</html>